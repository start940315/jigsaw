/*
 frontend powered By Startan
 Designed By xiang
 producted By fei
 */
function getHost(){return HOST&&HOST.length?HOST:(HOST=window.location,HOST=HOST.protocol+"//"+HOST.host+"/"+GAMEID,HOST.indexOf("file")>=0&&(HOST="."),HOST)}!function(){for(var a=0,b=["webkit","moz"],c=0;c<b.length&&!window.requestAnimationFrame;++c)window.requestAnimationFrame=window[b[c]+"RequestAnimationFrame"],window.cancelAnimationFrame=window[b[c]+"CancelAnimationFrame"]||window[b[c]+"CancelRequestAnimationFrame"];window.requestAnimationFrame||(window.requestAnimationFrame=function(b){var c=(new Date).getTime(),d=Math.max(0,16.7-(c-a)),e=window.setTimeout(function(){b(c+d)},d);return a=c+d,e}),window.cancelAnimationFrame||(window.cancelAnimationFrame=function(a){clearTimeout(a)})}();var Transitionend="ontransitionend"in window?"transitionend":"webkitTransitionEnd",GAMEID=10000190,HOST=getHost();Zepto(function(a){function b(a,b,c,d,e){this.index=a,this.size=b,this.oriX=a%c*b,this.oriY=Math.floor(a/c)*b,this.offsetX=0,this.offsetY=0,this.startX=0,this.startY=0,this.linkList=[a],this.el=null,this.top=a,this.init(e)}var d={ready:function(){a(".select").removeClass("select"),a("h2").one(Transitionend,function(){setTimeout(function(){a(".container").addClass("show-btn")},50)}),a(".container").removeClass("step1 step3 show-ctr").addClass("step2"),d.state[0]=!1,d.state[1]=!1,n.play("oui"),a(".mode-btn-wr").on("touchstart",".btn",function(b){var c=a(b.target);n.play("oui"),c.hasClass("large")?(a(".large .select").removeClass("select"),c.addClass("select"),d.mode=+c.data("mode"),d.state[0]=!0,2===d.mode&&(d.difficulty=1,d.state[1]=!0)):(a(".small .select").removeClass("select"),c.addClass("select"),d.difficulty=+c.data("difficulty"),d.state[1]=!0),d.finish()&&j.fire()})},state:[!1,!1],mode:-1,difficulty:-1,setDom:function(){var b="",c="";switch(d.mode){case 1:b="限时模式";break;case 2:b="进阶模式";break;case 3:b="计时模式"}if(2!==d.mode)switch(d.difficulty){case 1:c="低能";break;case 2:c="中能";break;case 3:c="高能"}a(".game-ctr .game-mode").html("<span class='m'>"+b+"</span><span class='d'>"+c+"</span>")},finish:function(){var a=d.state;return a[0]&&a[1]}},e={w:a(window).width(),h:a(window).height()};try{yw.init({gameId:GAMEID,width:e.w,height:e.h})}catch(f){alert(f.message)}var g=b.prototype;g.init=function(a){var b=document.createElement("canvas");b.width=this.size,b.height=this.size;var c=b.getContext("2d");c.drawImage(a,this.oriX,this.oriY,this.size,this.size,0,0,this.size,this.size),j.canvas.jigsaw.getContext("2d").drawImage(a,this.oriX,this.oriY,this.size,this.size,0,0,this.size,this.size),this.el=b},g.move=function(a,b){for(var c=this.offsetX=this.startX+a,d=this.offsetY=this.startY+b,e=this.linkList,f=j.frags,g=0,h=e.length;h>g;g++)f[e[g]].offsetX=c,f[e[g]].offsetY=d;return{x:c,y:d}},g.isLinked=function(b){return-1!==a.inArray(b,this.linkList)},g.link=function(a,b){var c=this.linkList;c=c.concat(a[b].linkList);var d,e;for(d=0,e=c.length;e>d;d++)a[c[d]].linkList=c;return this.setTop(),c.length},g.setTop=function(){this.top=++j.moveElId,j.draw("moving",3,this.index),j.draw("jigsaw",2,this.index)},g.draw=function(a,b){var c={},d=this.linkList,e=j.frags;if(b)a.drawImage(this.el,this.oriX+this.offsetX,this.oriY+this.offsetY);else for(var f=0,g=d.length;g>f;f++)c=e[d[f]],a.drawImage(c.el,c.oriX+c.offsetX,c.oriY+c.offsetY)};var h={el:a(".game-ctr .timer .value"),limit:0,timeId:0,result:0,reset:function(){if(h.el.text("00:00"),1===d.mode)switch(d.difficulty){case 1:h.limit=22;break;case 2:h.limit=180;break;case 3:h.limit=600}},normalize:function(a){var b=Math.floor(a/60),c=a%60;return b=("0"+b).substr(-2),c=("0"+c).substr(-2),b+":"+c},setDom:function(a){"string"!=typeof a&&(a=h.normalize(a)),h.el.text(a)},countDown:function(a,b){function c(){h.setDom(a),a--,h.result=a,0>a?b&&b():h.timeId=setTimeout(c,1e3)}clearTimeout(h.timeId),h.timeId=setTimeout(c,1e3)},count:function(){function a(){h.setDom(b),b++,h.result=b,h.timeId=setTimeout(a,1e3)}var b=0;clearTimeout(h.timeId),h.timeId=setTimeout(a,1e3)},stop:function(){clearTimeout(h.timeId)}},i=0,j={wr:a(".frag-wr"),canvas:{jigsaw:a("#jigsaw").get(0),moving:a("#moving").get(0)},imgIndex:1,moveElId:110,frags:[],col:0,row:0,size:0,nowDi:0,fire:function(){j.nowDi=d.difficulty,h.reset(),j.wr.css("margin-top",(e.h-460)/2+"px"),j.ready(),a(".container").removeClass("step2 show-btn"),a(".mode-btn-wr .btn").eq(0).one(Transitionend,function(){setTimeout(function(){j.wr.one(Transitionend,function(){a(".container").addClass("show-ctr")}),a(".container").addClass("step3")},10)})},ready:function(){function b(){c.text(d+"秒钟记图"),d--,0>d?j.messup():setTimeout(b,1e3)}j.frags=[],j.moveModule.list=[],j.imgIndex=j.nowDi,j.generateView();var c=a(".game-ctr .game-mode"),d=5;b()},messup:function(){function a(){i++;for(var c=i/k,d=0,f=frags.length;f>d;d++)frags[d].move(e[d].x*c|0,e[d].y*c|0);if(j.draw("jigsaw",1),k>i)requestAnimationFrame(a);else{for(var d=0,f=frags.length;f>d;d++)frags[d].offsetX=e[d].x,frags[d].offsetY=e[d].y;b()}}rx=0,ry=0,c=0,r=0,col=j.col,row=j.row,size=j.size,frags=j.frags,pos={},d.setDom();for(var b=function(){j.bind(),1===d.mode?h.countDown(h.limit,j.fail):(2===d.mode&&1===j.nowDi||3===d.mode)&&h.count()},e=[],f=0,g=frags.length;g>f;f++)c=f%col,r=Math.floor(f/col),rx=Math.random()*(300-size)|0,ry=Math.random()*(400-size)|0,pos={x:rx-c*size,y:ry-r*size},e.push(pos);var i=0,k=50;requestAnimationFrame(a)},generateView:function(){var a=0,c=j.nowDi;1===c?a=12:2===c?a=48:3===c&&(a=108);var d,e=100/c|0,f=0,g=3*c,h=g/3*4;j.size=e,j.col=g,j.row=h;var i=document.createElement("canvas");i.width=e*g,i.height=e*h;var k=new Image;console.log(e*g,e*h),k.onload=function(){var c=i.getContext("2d");c.drawImage(k,0,0,300,400),c.strokeWidth=1,c.strokeStyle="#FFFFFF",c.beginPath();for(var l=0,m=h;m>l;l++)c.moveTo(.5,l*e+.5),c.lineTo(g*e+.5,l*e+.5);for(var l=0,m=g;m>l;l++)c.moveTo(l*e+.5,.5),c.lineTo(l*e+.5,h*e+.5);c.closePath(),c.stroke(),c.beginPath(),c.strokeStyle="#6C6C6C";for(var l=0,m=h;m>l;l++)c.moveTo(.5,(l+1)*e-.5),c.lineTo(g*e-.5,(l+1)*e-.5);for(var l=0,m=g;m>l;l++)c.moveTo((l+1)*e-.5,.5),c.lineTo((l+1)*e-.5,h*e-.5);for(c.closePath(),c.stroke(),f=0;a>f;)d=new b(f,e,g,h,i),j.frags.push(d),f++;c=null,i=null,k=null,j.draw("jigsaw",1)},k.src=HOST+"/static/img/winnie"+j.nowDi+".jpg"},bind:function(){var b=j.wr,c=b.offset();b.on("touchstart",function(a){if(j.moveModule.list.length>0)return void a.preventDefault();var b=a.touches[0];j.moveElId=b.identifier,j.moveModule.add(b.clientX-c.left,b.clientY-c.top,j.moveElId)}),b.on("touchmove",function(a){var b=a.touches[0];!j.drawId&&j.moveModule.list.length&&j.moveModule.move(b.clientX-c.left,b.clientY-c.top,b.identifier)}),b.on("touchend touchcancel",function(){j.moveModule.remove()}),a(".game-ctr .back").one("touchstart",function(){confirm("确定返回吗？")&&(j.destroy(),d.ready())})},unbind:function(){j.wr.off(),a(".game-ctr .back").off()},detectCat:function(a){for(var b=(j.size,-1),c=-1,d=[[-1,0],[0,1],[1,0],[0,-1]],e=j.frags,f=e[a].index,g=f%j.col,h=Math.floor(f/j.col),i=1e4,k=1e4,l=-1,m=!1,o=0,p=0,q=d.length;q>p;p++)if(c=h+d[p][0],b=g+d[p][1],c>=0&&c<j.row&&b>=0&&b<j.col){for(l=e.length,o=c*j.col+b;--l&&e[l].index!==o;);if(l>=0&&!e[a].isLinked(l)&&(i=Math.abs(e[l].offsetX-e[a].offsetX),k=Math.abs(e[l].offsetY-e[a].offsetY),5>i&&5>k)){if(e[a].link(e,l)===j.frags.length)return j.pass(),!0;n.play("oui"),m=!0}}return!1},drawId:0,draw:function(b,c,d){a(".test").text(new Date-i),j.drawId&&cancelAnimationFrame(j.drawId);var e=j.canvas[b],f=e.getContext("2d"),g=j.frags,h=g[d||1];requestAnimationFrame(function(){i=+new Date,j.drawId=0;f.clearRect(0,0,300,400);var a=[];if(1===c||2===c){for(var b=0,e=g.length;e>b;b++){for(var k=0,l=a.length;l>k;k++)if(g[b].top<a[k].top){k--;break}a.splice(k,0,g[b])}g=a,console.log(g)}if(1===c)for(var b=0,e=g.length;e>b;b++)g[b].draw(f,!0);else if(2===c)for(var b=0,e=g.length;e>b;b++)h.isLinked(g[b].index)||g[b].draw(f,!0);else 3===c&&g[d].draw(f)})},detectTouched:function(a,b){for(var c=j.frags,d=j.size,e=-1,f=-1,g=-1,h={},i=-1,k=c.length-1;k>i;k--)if(h=c[k],e=a-(h.oriX+h.offsetX),f=b-(h.oriY+h.offsetY),e>=0&&f>=0&&d>=e&&d>=f){g=k;break}return g},moveModule:{list:[],add:function(a,b,c){var d,e=j.moveModule.list;if(!e.length&&-1!==(d=j.detectTouched(a,b))){var f=j.frags[d];f.setTop(d),f.startX=f.offsetX,f.startY=f.offsetY,e[0]={index:d,x:a,y:b,id:c}}},move:function(a,b,c){var d=j.moveModule.list;if(d.length&&j.moveElId===c){var e,f=d[0].index;j.detectCat(f),e=j.frags[f].move(a-d[0].x,b-d[0].y),j.draw("moving",3,d[0].index)}},remove:function(){j.moveModule.list=[],j.draw("jigsaw",1),j.draw("moving",0)}},fail:function(){j.destroy(),k.show("so sad...时间已到~",1),n.play("fail")},pass:function(){2===d.mode&&j.nowDi<3?(j.nowDi++,requestAnimationFrame(function(){j.ready()})):(j.destroy(),k.show("通关成功！",2)),n.play("pass")},destroy:function(){j.unbind(),h.stop();for(var a=j.frags,b=0,c=a.length;c>b;b++)a[b].el=null;j.frags=null}};a("body").on("touchmove",function(a){a.preventDefault()}),a("#start-btn").one("touchstart",d.ready);for(var k={el:a(".pop"),textel:a(".pop").find(".pop-card .text-wr"),btn:a(".pop .btn-wr"),show:function(a,b,c){if(k.textel.text(a),k.el.addClass("show"),"number"!=typeof b)k.hideBtn(),k.el.one("touchstart",function(){k.hide()}),c=b;else{k.showBtn();var d=k.btn.find("button");1===b?d.eq(0).text("找人帮忙"):2===b&&d.eq(0).text("低调秀一下"),k.bindBtn(b)}},hide:function(){k.el.removeClass("show")},hideBtn:function(){k.btn.css("display","none")},showBtn:function(){k.btn.css("display","block")},bindBtn:function(b){k.btn.on("touchstart",function(c){var e=c.target;if(a(e).hasClass("replay"))d.ready(),k.hide();else{if(!a(e).hasClass("share"))return;m.show(b,h.result)}})}},l={shareImageUrl:HOST+"/static/img/icon.jpg",bgs:[HOST+"/static/img/winnie1.jpg",HOST+"/static/img/winnie2.jpg",HOST+"/static/img/winnie3.jpg"]},m={data:{title:"拼出维尼熊",text:"我正在拼维尼熊，啊~！好喜欢维尼熊~",imageUrl:l.shareImageUrl},shareTpl:[{title:"拼出维尼熊",text:"So sad...我没能把高能维尼熊拼出来，求助大神~",imageUrl:l.shareImageUrl},{title:"拼出维尼熊",text:"So sad...我竟没能把中能维尼熊拼出来，求助大神~",imageUrl:l.shareImageUrl},{title:"拼出维尼熊",text:"So sad...我连低能维尼熊都没拼出来，我面壁去了",imageUrl:l.shareImageUrl},{title:"拼出维尼熊",text:"我在计时模式中拼出了$difficulty$的维尼熊，还剩$time$秒哦！",imageUrl:l.shareImageUrl},{title:"拼出维尼熊",text:"呕液~我花了$time$秒成功拼出了$difficulty$的维尼熊~求超越~",imageUrl:l.shareImageUrl},{title:"拼出维尼熊",text:"我花了$time$秒完成了进阶模式的维尼熊拼图，速来膜拜~",imageUrl:l.shareImageUrl}],show:function(a,b){a&&0!==a?1===a?m.setData(1):2===a&&m.setData(2,b):m.setData(0),yw.openSocialShareMenu(m.data,function(a,b){a&&k.show(b.toString())})},setData:function(b){var c={};if(0===b)a.extend(!0,c,m.shareTpl[0]);else if(1===b)switch(d.difficulty){case 1:a.extend(!0,c,m.shareTpl[1]);break;case 2:a.extend(!0,c,m.shareTpl[2]);break;case 3:a.extend(!0,c,m.shareTpl[3])}else if(2===b){switch(d.mode){case 1:a.extend(!0,c,m.shareTpl[4]);break;case 2:a.extend(!0,c,m.shareTpl[5]);break;case 3:a.extend(!0,c,m.shareTpl[6])}var e="";switch(d.difficulty){case 1:e="低能";break;case 2:e="中能";break;case 3:e="高能"}c.text=c.text.replace(/\$difficulty\$/g,e).replace(/\$time\$/g,h.result)}m.data=c}},n={playing:"",tracks:{oui:a("#audio-oui").get(0),fail:a("#audio-fail").get(0),pass:a("#audio-pass").get(0)},play:function(a){n.playing===a&&n.pause(),n.playing=a,n.tracks[a].play()},pause:function(){n.playing.length&&n.tracks[n.playing].pause()&&(n.tracks[n.playing].currentTime=0)}},o=0,p=l.bgs.length;p>o;o++)a(".preload").append("<img src='"+l.bgs[o]+"'>")});